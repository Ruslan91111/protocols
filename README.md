# Protocols

**Protocols** – пакет, содержащий код для извлечения данных из файлов формата .pdf и записи изъятых данных в Базу Данных.
На текущий момент работа осуществляется с файлами, содержащими протоколы "Лига-Серт".  

### Описание процесса

Запуск работы с указанным приложением осуществляется с активации виртуальной окружающей среды и запуска 
через консоль файла cli\main_cli.py.

При запуске файла в окне терминала отображается меню, а именно перечисление чисел и описание процессов, соответствующих
данным цифрам. После приглашения ввода необходимо ввести соответствующую цифру и нажать *Enter*.


Меню при запуске проекта:
1. Выполнить весь процесс
2. Конвертировать PDF в DOCX
3. Записать файлы в БД
4. Записать файлы через корректировки
5. Переименовать файлы
6. Сжать файлы
7. Удалить страницы из PDF
8. Работа с таблицами в БД
0. Выход


При выборе 1 пункта, осуществляется: к
- Конвертация файлов в формат .docx. 
- Переименование файлов согласно паттерна: номер магазина и дата протокола. 
- Сжатие файлов.
- Парсинг файлов и запись в Базу Данных.

### Описание основных процессов.

### 1. Конвертация.

Процесс конвертации определен в пакете conversion\

Запуск конвертации через вызов функции:
****protocols\conversion\convert_files_all.py::convert_all_pdf_in_dir_to_docx****.

Процесс конвертирования построен следующим образом: 
- Открытие программы FineReader при помощи библиотеки pyautogui.
- Навигация по меню, ввод директории с файлами формата .pdf.
- Выбор всех файлов в директории.
- Создание в директории с файлами формата .pdf директории word_files\.
- Ввод данной директории для сохранения конвертированных файлов формата .docx. 
- Запуск конвертации.
- Ожидание появления всех конвертированных файлов в директории word_files.


### 2. Переименование.

Процесс переименования определен в пакете rename_files\

Запуск переименования через вызов функции:
****protocols\rename_files\rename_files.py::rename_the_files_in_dir****

Процесс переименования построен следующим образом: 
- Чтение через цикл файлов формата .docx.
- Поиск в тексте и таблицах кодового обозначения магазина и даты протокола.
- Переименование файла формата .docx.
- Переименование файла формата .pdf.


### 3. Сжатие файлов.

Процесс сжатия определен в пакете compress_pdfs\

Запуск переименования через вызов функции:
****protocols\compress_pdfs\compress_file_aspose.py::compress_files_in_dir****

Процесс сжатия построен следующим образом: 
- Вызывается функция compress_files_in_dir и передается директория, содержащая не сжатые файлы оригинального размера
- Через цикл каждый файл формата .pdf сжимается при помощи библиотеки aspose. Сжатие происходит синхронно.
- Сжатые файлы располагаются в директории *compressed_files*, в той же директории, что и оригинальные файлы. При 
необходимости замены оригиналов на сжатые файлы, предлагается сделать это вручную путем переименования файлов.


### 4. Парсинг данных из документа и их дальнейшая запись в БД.

Процесс задействует все пакеты и модули директории league_sert\

Запуск записи в БД через вызов функции:
****protocols\league_sert\db_operations\db_writer.py::write_files_to_db_from_dir****

Процесс построен следующим образом:
- Формирует список файлов формата .docx, нуждающихся в записи, пропускаются временные файлы, а также файлы ранее,
уже записанные в БД.
- Посредством пула процессов к указанным файлам применяется функция 
process_and_write_file_task и происходит асинхронная запись данных в Базу Данных.
- Незаписанные файлы как в формате .pdf, так и в формате .pdf перемещаются в директории unrecorded.

process_and_write_file_task - функция для записи одного файла в БД.

### Парсинг файлов и запись информации в Базу Данных состоит из следующих этапов: 

#### 4.1. Формирование данных для записи

Процесс задействует пакет league_sert\data_preparation

****protocols\league_sert\data_preparation\launch_data_preparation.py::extract_and_prepare_data****

- Через вызов указанной функции создается объект класса MainCollector, при инициализации передается путь
к файлу формата .pdf. 
- Через вызов метода collect_all_data() осуществляется получение и преобразование данных из документа.
 
Работа данного метода состоит из нескольких этапов:

1. Через вызов метода *get_main_information()* получаем основные номер и дату протокола. Получение указанных данных 
осуществляется через попытку найти искомые данные в сплошном тексте документа, в таблицах, поиск отдельно даты.
2. Через вызов метода *get_data_from_tables()* - получаем данные из таблиц. 
Получение указанных данных осуществляется при помощи объекта класса CollectorFromTable. При получении данных из таблиц 
сначала происходит попытка устранения ошибок, связанных с неправильной конвертацией. Затем из 
таблиц изымаются данные, таблицы обрабатываются в зависимости от количества колонок и содержания первый строк.
3. Через вызов метода *get_prod_control_data()* выбираются номер и дата протокола производственного контроля, а также
наличие и содержание заключения.
4. Обработка данных из таблиц .docx файла, исправление дефектов, вызванных ошибками при конвертации,
такие как: исправление ошибок, связанных с неправильным разделением таблиц,
добавление лишних строк и колонок и другие ошибки метод - *process_the_tables()*.
5. Через вызов функции *fix_the_keys_in_all_tables()* и передачу в нее в качестве аргумента 
данных полученных из таблиц .docx осуществляется исправление ключей в таблицах. Поиск и исправление 
ошибок происходит через регулярные выражение и библиотеку re, которые определены в модуле constants.py 
в корневом каталоге.
6. С помощью вызова функции add_conclusions_for_all_tables() и передачи в нее данных из таблиц
добавляем в данные выводы о соответствии результатов исследований нормам исследований. 
Вывод о соответствии представлен в виде True и False, если показатель результат исследований 
содержит "±", то вывод о соответствии будет представлен в виде *tuple(bool, bool)*
7. С помощью вызова функции refine_and_merge_tables и передачи в нее данных из таблиц объединяем
таблицы с описанием проб и результатами исследований. Результаты исследований хранятся под ключом 
*indicators*.
8. С помощью вызова метода *merge_prod_control* объединяем данные по производственному контролю.

Итог работы парсинга данных из файла формата .docx - объект класса MainCollector, хранящий данные
свойствах.

#### 4.3. Создание объектов из данных, полученных в результате парсинга данных.

****protocols\league_sert\db_operations\db_writer.py::create_all_objects****
Данная функция создает из данных полученных в результате парсинга набор объектов 
соответствующих классов.
Классы написаны на SQLAlchemy и определены в ****protocols\league_sert\models.models.py****
 - MainProtocol; 
 - ManufProd; 
 - Air; 
 - Washings;
 - StoreProd; 
 - ProdControl; 
 - Water.

Основной и обязательный объект - объект класса MainProtocol. Объект указанного класса может быть
один на один документ, отсутствовать не может. Остальные классы имеют связь в виде внешнего ключа на 
указанный класс. Обязательно также наличие объекта класса ProdControl, наличие остальных классов 
необязательно, в зависимости от наличия в документах.


#### 4.4. Запись в Базу Данных.

****protocols\league_sert\db_operations\db_writer.py::create_all_objects****
Данная функция создает из данных полученных в результате парсинга набор объектов 
соответствующих классов.
Классы написаны на SQLAlchemy и определены в ****protocols\league_sert\models.models.py****
 - MainProtocol; 
 - ManufProd; 
 - Air; 
 - Washings;
 - StoreProd; 
 - ProdControl; 
 - Water.

Основной и обязательный объект - объект класса MainProtocol. Объект указанного класса может быть
один на один документ, отсутствовать не может. Остальные классы имеют связь в виде внешнего ключа на 
указанный класс. Обязательно также наличие объекта класса ProdControl, наличие остальных классов 
необязательно, в зависимости от наличия в документах.

Непосредственно перед записью устанавливаются связи объектов классов на объект класс MainProtocol. 
Затем проверяется наличие в БД объекта класса MainProtocol с аналогичными данными. 
Запись в БД осуществляется в рамках транзакции, в случае возникновения ошибки, происходит откат
и никакие объекты не записываются в БД.


## Описание остальных пунктов меню

### Пункты: 2,3,5,6 - обособленные части общего описанного процесса. 

### Пункт меню № 4. Записать файлы через корректировки

- Сохранение данных из файла формата .docx путем внесения изменения в сам файл.

Процесс задействует пакет league_sert\manual_entry\

****protocols\league_sert\manual_entry\db_writer_debug.py::write_files_to_db_from_dir_debug****

При запуске указанной функции и передаче в качестве аргумента директории, в которой находятся файлы 
формата .pdf осуществляется запись в БД следующим образом:
- При первичной записи в БД, файлы, которые не смогли быть распарсены надлежащим образом и записаны
в БД, были перемещены в директорию *unrecorded*, директории с данным названием создаются как в общей 
директории, в которой находились файлы формата .pdf, так и в директории *word_files*/
Программа пытается распарсить файл и записать данные в Базу. При возникновении исключения - предопределенные
ошибки дают подсказку, в чем проблема. Открывается файл .docx и соответствующий файл .pdf. Также в
консоли программы выводится соответствующая подсказка. Далее пользователю программы предлагается
внести соответствующие изменения в файл .docx и сохранить его. При внесении изменений и сохранении 
файла, программа пытается записать данные в Базу повторно. В случае успешной записи, файл перемещается
в общую для .pdf файлов директорию, аналогично как и его конвертированная версия.


### Пункт меню № 7. Удалить страницы из PDF

****protocols\conversion\remove_pages_in_pdf.py****
- Далее пользователю предлагается ввести путь к .pdf файлу, а также ввести номера страниц, подлежащих удалению


### Пункт меню № 8. Работа с таблицами в БД
Данный пункт предназначен для администратора Базы Данных. При попытке войти в него, пользователю 
предлагается ввести пароль. При вводу валидного пароля, предоставляется меню для работы с БД.
CLI для работы с БД определен в ****protocols\cli\cli_db_manager.py****. 
Код работы с БД определен в ****protocols\database\db_manager.py****.

## Структура проекта

### Файлы и папки в корне проекта:

- `.gitignore` — файл для исключения файлов и папок из репозитория Git.
- `.env` — переменные для установления соединения с БД.
- `pyproject.toml` — файл с зависимостями проекта.
- `structure_of_project.txt` — файл с описанием структуры проекта.

#### Пакет `cli`: 

пакет с модулями для работы CLI 

- `__init__.py` — инициализация пакета.
- `cli_db_manager.py` — CLI для работы с таблицами в БД.
- `main_cli.py` — файл с кодом для работы CLI.
- `utils.py` — вспомогательные функции для работы CLI.


#### Пакет `comparator`: 

пакет с кодом, отвечающим за сравнение результата исследования с нормами и выдачей результата о соответствии. 

- `__init__.py` — инициализация пакета.
- `comparator.py` — код, принимающий результат исследования и норму, сравнивающий определенным методом и формирующий вывод о соответствии или несоответствии. 


#### Пакет `compress_pdfs`: 

пакет с кодом, отвечающим за сжатие файлов формата .pdf. 

- `__init__.py` — инициализация пакета.
- `compress_file.py` — код, сжимающий файл формата .pdf при помощи библиотек fitz, PIL. 
- `compress_file_aspose_pdf.py` — код, сжимающий файл формата .pdf при помощи библиотеки aspose. Функция compress_files_in_dir - применяет данное сжатие для всех файлов в директории.
- `compresses_files.txt` — текстовой файл с перечнем уже сжатых файлов.


#### Пакет `conversion`: 

пакет с кодом, отвечающий за конвертацию файлов формата .pdf в файлы формата .docx для последующего парсинга данных.

- `__init__.py` — инициализация пакета.
- `convert_files_all.py` — конвертирование файлов формата .pdf из определенной директории работа с FineReader с помощью библиотеки pyautogui. За один раз передаются все файлы.
- `convert_files_in_dir_by_one.py` — конвертирование файлов формата .pdf из определенной директории с помощью FineReader, ввод по одному файлу, после конвертации, осуществляется проверка содержимого docx файла на наличие номера и даты протокола.
- `exceptions.py` — исключения для работы данного пакета.
- `files_and_proc_utils.py` — отдельные вспомогательные функции для работы с файлами и процессами.
- `remove_back_elements.py` — код для удаления с фона элементов синего цвета из файла формата pdf.
- `remove_pages_in_pdf.py` — код для удаления страниц из файла формата pdf.
- `screen_work.py` — функции для работы со скриншотами, поиск, нажатие, ожидание исчезновения скриншота.
- `screenshots/` — директория со скриншотами для работы приложения.


#### Пакет `database`: 

пакет с кодом, отвечающим за сжатие файлов формата .pdf. 

- `__init__.py` — инициализация пакета.
- `base.py` — ссылка на базовый декларативный класс. 
- `db_config_postgres.py` — конфигурация подключения к БД, фабрика сессий.
- `db_manager.txt` — класс и методы для операций с БД и таблицами в ней.


### Пакет `league_sert`: 

пакет с кодом для работы с протоколами "Лига-СЕРТ"

- `__init__.py` — инициализация пакета.
- `constants.py` — константы
- `exceptions.py` — исключения для работы данного пакета.
- `write_to_xlsx.py` — содержит сырой sql запрос, который получает данные из БД и записывает их в xlsx файл.


##### Пакет `data_preparation`:

пакет, содержащий код для изъятия, преобразования данных в файле формата .docx. также сравнение результатов с требованиями норм и добавление выводов о соответствии в таблицы.
- `__init__.py` — инициализация пакета.
- `add_conclusions.py` — определить тип таблицы результата, в зависимости от типа таблицы результатов выполняется определенная логика. Выводы о соответствии каждого результата нормам добавляются в таблицу с результатами.
- `exceptions.py` — исключения для работы данного пакета.
- `work_with_browser.py` — организация работы в браузере.
- `file_parser.py` — изъятие данных из файла формата .docx, чтение файла, получение данных из сплошного текста, а также из таблиц.
- `fix_the_values.py` — исправить орфографические ошибки, допущенные в результате конвертации.
- `launch_data_preparation.py` — запустить изъятие и преобразование данных из файла. 
- `merge_tables.py` — объединить таблицы показателей с таблицами описания образцов. 
- `process_tables.py` — обработать таблицы, устранить дефекты, полученные в результате неправильной конвертации, такие как: ошибочное разделение строк и колонок, добавление лишних данных и др.  
- `value_processor.py` — обработать значения результатов и норм, привести их в вид, подходящий для выполнения сравнения.  


##### Пакет `db_operations`:

пакет с кодом для записи данных из файлов формата .docx в БД. 
- `__init__.py` — инициализация пакета.
- `db_writer.py` — код для записи данных в БД. Запись асинхронная, через процессы. При записи проверяется имеется ли данная сущность в БД, а также устанавливаются необходимые внешние связи между таблицами.
- `file_utils.py` — вспомогательные функции для работы с файлами в рамках работы пакета.
- `viewed.txt` — текстовый файл, содержащий перечень записанных в БД файлов.


##### Пакет `manual_entry`:

пакет с кодом для записи данных из файлов формата .docx в БД через корректировку word файлов, внесения изменений в документ. При запуске данного модуля, осуществляется попытка получить данные из файла и записать их в БД. Если имеется ошибка связанная с плохой конвертацией файла, то открывается соответствующий файл в формате .docx и в формате .pdf. Дается по возможности подсказка, где ошибка, вносятся изменения в .docx файл, сохраняется. Если данных изменений достаточно, то данные записываются в БД, а файлы перемещаются в общую папку.
- `__init__.py` — инициализация пакета.
- `db_writer_debug.py` — запись в БД через корректировку файлов формата .docx. Берется перечень файлов, находящихся в директории для незаписанных в БД, ввиду ошибок в файле .docx. Далее, каждый файл открывается как в формате .docx, так и в формате .pdf. В консоли выводится подсказка, какая ошибка присутствует. Пользователь исправляет ошибку, сохраняет файл .docx, в консоли нажимает <Enter>. Файл повторно читается и осуществляется попытка записи в БД. Если запись осуществлена, то файл перемещается к остальным файлам.
- `exceptions.py` — исключения для работы данного пакета.
- `file_parser_manual.py` — код изъятия и преобразования данных из файла формата .docx с учетом особенностей для внесения данных через корректировки. 
- `manual_handler_exceptions.py` — обработчики ошибок при записи данных из файлов формата .docx вручную через корректировки файлов. 
- `models_creator_debug.py` —  модуль с кодом для создания объектов моделей при записи в БД через корректировки файлов формата .docx
- `viewed.txt` — текстовый файл, содержащий перечень записанных в БД файлов.


##### Пакет `rename_files`:

пакет, содержащий код, отвечающий за создание моделей на SQLAlchemy
- `__init__.py` — инициализация пакета.
- `rename_files.py` — код, отвечающий за переименование файлов.


#### Пакет `tests`:

Пакет с тестами на pytest.

## Схематичная структура проекта представлена в корневом файле:
### structure_of_project.txt

## Зависимости проекта определены в:
### pyproject.toml

## Установка:
1. Клонировать репозиторий: git clone https://github.com/Ruslan91111/protocols
2. Установить Poetry.
3. Установить зависимости из `pyproject.toml`.
4. Разместить в корневой директории poppler-23.11.0
5. Разместить в корневой директории файл *.env*
   в нем определить переменные DB_PASSWORD, DB_HOST, DB_PORT, DB_NAME, DB_PWD_CLI - 
   для установления соединения с Базой Данных.
6. Запустить: python protocols\cli\main_cli.py

